<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang="en" xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:a="http://xmlns.jcp.org/jsf/passthrough">
<h:head></h:head>
<h:body>
<ui:composition template="/templates/layout_user.xhtml">
		<ui:define name="contenido">
		<style>
		
		   
		</style>
			<div class="container-fluid clearfix">
				<div class="list-group">
					<section class="content">
					<div class="row">
						<div class="col-lg-3 col-xs-6">
							<!-- small box -->
							<div class="small-box bg-yellow">
								<div class="inner">
									
									
									<h3>${avBean.cantUsuariosCompartidos()}</h3>
															
									<p>Usuarios Compartidos</p>
								</div>
								<div class="icon">
									<i class="ion ion-person-add"></i>
								</div>


								<h:form class="small-box-footer">
									<h:commandLink
									
										action="#{avBean.mostrarListaUsuariosCompartidos()}"
										style="text-decoration:none;color:white;">
			                                Mas información
			                              <i class="fa fa-arrow-circle-right"></i>
									</h:commandLink>
								</h:form>

							</div>
						</div>
						<!-- ./col -->
						<div class="col-lg-3 col-xs-6">
							<!-- small box -->
							<div class="small-box bg-teal">
								<div class="inner">
									<h3>#{avBean.cats.size()}</h3>
									<p>Categorias</p>
								</div>
								<div class="icon">
									<i class="ion ion-ios7-pricetag-outline"></i>
								</div>
								<h:form class="small-box-footer">
									<h:commandLink action="verListaCategoria"
										actionListener="#{avBean.mostrarListaCategoria()}"
										style="text-decoration:none;color:white;">
			                                Mas información
			                             <i class="fa fa-arrow-circle-right"></i>
									</h:commandLink>
								</h:form>

							</div>
						</div>
						<!-- ./col -->
						<div class="col-lg-3 col-xs-6">
							<!-- small box -->
							<div class="small-box bg-maroon">
								<div class="inner">
									<h3>${productoBean.verCantProd()}</h3>
									<p>Productos</p>
								</div>
								<div class="icon">
									<i class="ion ion-ios7-pricetag-outline"></i>
								</div>
								<h:form class="small-box-footer">
									<h:commandLink action="verListaProducto"
										style="text-decoration:none;color:white;">
			                                Mas información
			                             <i class="fa fa-arrow-circle-right"></i>
									</h:commandLink>
								</h:form>
								
							</div>
						</div>
						<!-- ./col -->
						<div class="col-lg-3 col-xs-6">
							<!-- small box -->
							<div class="small-box bg-aqua">
								<div class="inner">
									<h3>150</h3>
									<p>Movimientos de Stock</p>
								</div>
								<div class="icon">
									<i class="ion ion-bag"></i>
								</div>
								<a href="#" class="small-box-footer"> Más información <i
									class="fa fa-arrow-circle-right"></i>
								</a>
							</div>
						</div>
						<!-- ./col -->
					</div>
					</section>
					<section class="content">
					<div class="row">
						<div class="col-md-6">
							<div class="box box-solid">
								<div class="box-header">
									<h3 class="box-title">Producto sugerido</h3>
								</div>
								<!-- /.box-header ************************************************
								<div class="box-body">
									<div id="carousel-example-generic" class="carousel slide"
										data-ride="carousel">
										<ol class="carousel-indicators">
											<li data-target="#carousel-example-generic" data-slide-to="0"
												class="active"></li>
											<li data-target="#carousel-example-generic" data-slide-to="1"
												class=""></li>
											<li data-target="#carousel-example-generic" data-slide-to="2"
												class=""></li>
										</ol>
										<div class="carousel-inner">
											<div class="item active">
												<img src="resources/adminlte/img/cebollaverdeo.jpg "
													alt="First slide"></img>
												<div class="carousel-caption">Cebolla de verdeo</div>
											</div>
											<div class="item">
												<img src="resources/adminlte/img/leche.jpg"
													alt="Second slide"></img>
												<div class="carousel-caption">Leche</div>
											</div>
											<div class="item">
												<img src="resources/adminlte/img/hamburguesa.jpg"
													alt="Third slide"></img>
												<div class="carousel-caption">Hamburguesa</div>
											</div>

										</div>
										<a class="left carousel-control"
											href="#carousel-example-generic" data-slide="prev"> <span
											class="glyphicon glyphicon-chevron-left"></span>
										</a> <a class="right carousel-control"
											href="#carousel-example-generic" data-slide="next"> <span
											class="glyphicon glyphicon-chevron-right"></span>
										</a>
									</div>
								</div>
								***************************************************************** -->
							</div>
						
						</div>
						

						<div class="row">
							<div class="col-md-6">
								<div class="box box-success">
									<div class="box-header">
										<h3 class="box-title">
											<i class="fa fa-comments-o"></i> Chat SAPo
										</h3>
										<div class="box-tools pull-right" data-toggle="tooltip"
											title="Status">
											<div class="btn-group" data-toggle="btn-toggle">

												<button type="button" class="btn btn-default btn-sm active">
													<i class="fa fa-square text-green"></i>
												</button>
												<button type="button" class="btn btn-default btn-sm">
													<i class="fa fa-square text-red"></i>
												</button>
											</div>
										</div>
									</div>

									<div class="box-body chat" id="chat-box">
										<div id="mensajesRecibidosChat"></div>
									</div>
									<!-- /.chat -->
									<div class="box-footer">
										<div class="input-group">
											<h:inputText styleClass="form-control mensajeDeChat"
												a:placeholder="Escriba su mensaje..." />
											<div class="input-group-btn">
												<h:form>
													<h:commandButton type="button" value="Enviar"
														styleClass="btn btn-success"
														onclick="javascript:enviarMensaje();" />
												</h:form>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					</section>
					<section class="content">

					<div class="col-md-6">
						<div class="box box-success">
						<h:form>
					<ui:param name="listaNotas" value="${avBean.mostrarNotas()}"></ui:param>
						
							<div class="box-header">

								<div class="input-group">
									<!-- Comments Form -->
									<h3 class="box-title">
										<i class="fa fa-edit"></i> Notas
									</h3>
								</div>
								<div class="box-body">
									<div class="form-group">
										<h:inputTextarea name="textNota" id="email_message"
											class="form-control" value="#{avBean.textNota}"
											placeholder="Nota..." style="height: 120px;" />

									</div>
										<h:commandButton id="botonEnviar" type="submit"
											styleClass="btn btn-primary pull-left" value="Enviar"
											action="mostrarAV" actionListener="#{avBean.crearNota()}"></h:commandButton>
									
								</div>
							</div>
						</h:form>
							
							<c:forEach var="nota" items="${listaNotas}">
							
							<hr>

								<!-- Comment -->

									<div class="box-body chat" id="chat-box">
										<div class="media">

											<div class="media-body">
												<h4 class="media-heading">#{nota.usuario}</h4>
												<h6>#{nota.texto}</h6>
											</div>
								
										</div>
									</div>

							</hr>
						</c:forEach>

						</div>
					</div>
					</section>
					
					<section class="content">
						<div class="col-md-6">
							<div class="box box-success">					
								<div class="box-header">
									<div class="input-group">
										<h3 class="box-title">
											<i class="fa fa-edit"></i> 
											Lista de Productos con bajo Stock
										</h3>
									</div>
								</div>
								<h:form>
									<table class="table table-striped table-resposive">
									    <thead>
									        <tr>
									            <th>Nombre Producto</th>
									            <th>Cantidad Stock</th>
									            <th>Agregar a lista de Compra</th>
									        </tr>
									    </thead>
									    <tbody>
									        <ui:param name="listaProductos" value="#{avBean.obtenerProductosConBajoStock()}"></ui:param>
											<c:forEach var="producto" items="${listaProductos}" >
										        <tr>
										            <td>${producto.getNombre()}</td>
										            <td>${producto.getStock()}</td>
										            <td>
										            	<h:commandButton value="Agregar a Lista de Compra" class="btn btn-primary" 
										            	onclick="return seleccionarProductoParaListaCompra('${producto.getNombre()}');" />
									            	</td>
										        </tr>
									        </c:forEach>
									    </tbody>
									    <tfoot>
									        <tr>
												<th>Nombre Producto</th>
									            <th>Cantidad Stock</th>
									            <th>Agregar a lista de Compra</th>
									        </tr>
									    </tfoot>
									</table>
									
								</h:form>
								
								<div class="modal fade" id="agregarProductoListaCompra_modal" role="dialog">
									<div class="modal-dialog">
										<div class="modal-content">
											<div class="modal-header">
												<button type="button" class="close" data-dismiss="modal">&times;</button>
												<h4 class="modal-title">Remplasar o Agregar</h4>
											</div>
											<h:form id="modal_productoSeleccionado">
												<div class="modal-body">
													<p>Ingrese la cantidad del artículo a comprar</p>
													<h:inputText type="number" min="1" id="cantidadProducto"  class="form-control"  placeholder="Cantidad" />
													<p>Si este producto ya existe en la lista ¿qué desea hacer?</p>
												</div>
												<div class="modal-footer">
													<h:panelGroup styleClass="agregarListaCompra">
														<h:inputHidden id="productoSeleccionado"/>
													</h:panelGroup>
													<h:commandButton actionListener="#{avBean.agregarProductoConBajoStock(true)}" value="Remplazar" class="btn btn-primary" />
													<h:commandButton actionListener="#{avBean.agregarProductoConBajoStock(false)}" value="Agregar" class="btn btn-success" />
													<button type="button" class="btn btn-default" data-dismiss="modal"><i class="fa fa-times"></i>Cancelar</button>
												</div>
											</h:form>
										</div>
									</div>
								</div>
							</div>
						</div>
					</section>
				
				</div>
			</div>
			<script type="text/javascript">

				function seleccionarProductoParaListaCompra(nombreProducto){
					$('.agregarListaCompra input[type=hidden]').val(nombreProducto);
					$('#agregarProductoListaCompra_modal').modal('show');
					return false;
				}
			
				$(document).ready(function() {
					$("#contenedorChat div.slimScrollDiv div.slimScrollBar").slimScroll({
				       start: 'bottom'
					});
				})
				
				
				$('.mensajeDeChat').keypress(function(e) {
				    if(e.which == 13) {
				    	enviarMensaje()
				    }
				});
				
				//var websockets = new WebSocket("ws://localhost:8080/Obligatorio/chat");
				var url = '#{usuarioBean.obtenerActualURL()}'; //Se obtiene la URL dinamiacamente
				url = url.replace("http://", ""); //Se elimina el http://
				url = url.replace("com:80/", "com:8000/"); //En la nube funciona en el puerto 8000
				var websockets = new WebSocket("ws://" + url + "chat"); 	
		
				websockets.onmessage = function(e){
					mostrarMensaje(e.data)
				}
				
				function enviarMensaje(){
					var mensaje = $(".mensajeDeChat").val();
					$(".mensajeDeChat").val("");
					if(mensaje != null){
						if(mensaje != "")
						{
							var enviar = {
								mensaje: mensaje,
								nickUsuario: '#{usuarioBean.nick}',
								nombreCompleto: '#{usuarioBean.obtenerNombreCompleto()}'
							}
							websockets.send(JSON.stringify(enviar));
						}
					}
				}

				function mostrarMensaje(data){
					var datos = JSON.parse(data);
					var fecha = document.createElement("i");
					$(fecha).addClass("fa fa-clock-o");
					var contFecha = document.createElement("small");
					$(contFecha).addClass("text-muted pull-right");
					contFecha.appendChild(fecha);
					contFecha.innerHTML += " " + datos.fecha; //Fecha del Mensaje
					var nombre = document.createElement("a");
					$(nombre).addClass("name");
					$(nombre).attr('href','#');
					nombre.appendChild(contFecha);
					nombre.innerHTML += datos.nombreCompleto; //Nombre del usuario
					var contMensaje = document.createElement("p");
					$(contMensaje).addClass("message");
					contMensaje.appendChild(nombre);
					contMensaje.innerHTML += datos.mensaje; //Mensaje
					var imagen = document.createElement("img");
					$(imagen).addClass("online");
					contMensaje.style.background = (!datos.soyYo ? "#f3f3f3" : "#cce5ff");
					contMensaje.style.padding = "15px";
					contMensaje.style.borderRadius = "10px";
					$(imagen).attr('src','imagenes/usuario/?nick=' + datos.nickUsuario); // Poner la imagen del usuario
					$(imagen).attr('alt','U'); //
					var contChat = document.createElement("div");
					$(contChat).addClass("item");
					
					contChat.appendChild(imagen);
					contChat.appendChild(contMensaje);	
					
					
					var contMensajes = document.getElementById("mensajesRecibidosChat");
					contMensajes.appendChild(contChat);

					var scrollTo_val = $('#contenedorChat div.slimScrollDiv').prop('scrollHeight') + 'px';
					$("#contenedorChat div.slimScrollDiv").slimScroll({ scrollTo : scrollTo_val });	
					
				}
			</script>
		</ui:define>
	</ui:composition>
</h:body>
</html>
